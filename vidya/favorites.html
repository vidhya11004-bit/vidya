<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Favorites - VIDYA</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #fdfdfd; margin: 0; padding: 0; }
        
        /* Purple Header Theme */
        .hero-banner {
            background: linear-gradient(135deg, #6e1bd6 0%, #ff2c92 100%);
            padding: 40px 20px;
            color: white;
            border-radius: 0 0 30px 30px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 4px 20px rgba(110, 27, 214, 0.2);
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        
        /* GRID LAYOUT for Favorites */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 25px; 
            min-height: 200px; 
            justify-items: center;
        }

        /* --- PURPLE CARD DESIGN --- */
        .college-card {
            width: 100%;
            max-width: 260px;
            background: #6e1bd6;
            color: white;
            padding: 25px 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(110, 27, 214, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            text-decoration: none;
        }

        .college-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(110, 27, 214, 0.35);
        }

        .college-card img {
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
            background: white; 
            padding: 8px;
            border-radius: 15px; 
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .college-card h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 45px;
            display: flex; align-items: center; justify-content: center;
        }

        .college-card p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0 0 20px 0;
            font-weight: 400;
        }

        .view-btn {
            margin-top: auto;
            background: white;
            color: #6e1bd6;
            padding: 8px 25px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        
        .view-btn:hover { background: #f0f0f0; transform: scale(1.05); }

        /* DELETE BUTTON */
        .btn-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 30px; height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
            z-index: 10;
        }
        .btn-remove:hover { background: #ff4757; transform: rotate(90deg); }

        .back-link { 
            display: inline-block;
            margin-top: 15px;
            color: rgba(255,255,255,0.9); 
            text-decoration: none; 
            font-weight: 600; 
            font-size: 1.1rem;
        }
        .back-link:hover { color: white; text-decoration: underline; }
    </style>
</head>
<body>

<div class="hero-banner">
    <div class="container">
        <h1 style="margin:0; font-size: 2.5rem; font-weight:800; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">My Favorite Colleges</h1>
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>
</div>

<div class="container">
    <div id="favGrid" class="grid">
        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
            <i class="fas fa-circle-notch fa-spin fa-2x" style="color: #6e1bd6;"></i>
            <p style="color: #666; margin-top: 15px;">Loading your favorites...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBt5DvViwm5ls_B4CWKYIYhMutJJ9opw_Y",
        authDomain: "vidyaproject-c4a1d.firebaseapp.com",
        projectId: "vidyaproject-c4a1d",
        storageBucket: "vidyaproject-c4a1d.firebasestorage.app",
        messagingSenderId: "637214484165",
        appId: "1:637214484165:web:f23e84c08cd6069f6fb2ac",
        measurementId: "G-647MPHBDGW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const favGrid = document.getElementById('favGrid');

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("Logged in as:", user.uid);
            loadFavorites(user.uid);
        } else {
            console.log("No user logged in, redirecting...");
            window.location.href = "login.html";
        }
    });

    async function loadFavorites(uid) {
        try {
            // Fetching from users -> UID -> favorites
            const querySnapshot = await getDocs(collection(db, "users", uid, "favorites"));
            
            if (querySnapshot.empty) {
                favGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                        <i class="far fa-heart fa-3x" style="color: #e0e0e0; margin-bottom: 20px;"></i>
                        <h3 style="color: #888;">No favorites yet</h3>
                        <p style="color: #aaa;">Go explore colleges and click the heart icon!</p>
                        <a href="index.html" style="display:inline-block; margin-top:10px; color:#6e1bd6; font-weight:bold;">Explore Now</a>
                    </div>`;
                return;
            }

            favGrid.innerHTML = ""; 
            
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const finalId = data.collegeId || docSnap.id; 
                const name = data.name || "Unknown";
                const loc = data.location || "Kerala";
                const logo = data.logo || "assets/default-college.png";

                const card = document.createElement('div');
                card.className = 'college-card'; 
                
                card.innerHTML = `
                    <button class="btn-remove" onclick="removeFavorite('${uid}', '${docSnap.id}', this)" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                    <a href="college.html?id=${finalId}" style="text-decoration:none; color:inherit; width:100%; display:flex; flex-direction:column; align-items:center;">
                        <img src="${logo}" alt="Logo">
                        <h3>${name}</h3>
                        <p>${loc}</p>
                        <span class="view-btn">View Details</span>
                    </a>
                `;
                favGrid.appendChild(card);
            });

        } catch (error) {
            console.error("Critical Error:", error);
            // PRINT ERROR TO SCREEN SO WE CAN SEE IT
            favGrid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; color: #d63031; background:#fff5f5; padding: 30px; border-radius:10px; border:1px solid #ffcccc;">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <h3 style="margin-top:10px;">Unable to Load Data</h3>
                    <p style="font-family:monospace; background:#eee; padding:10px; border-radius:5px; display:inline-block;">${error.message}</p>
                    <p style="margin-top:10px;">Please check your internet connection or Firebase permissions.</p>
                </div>`;
        }
    }

    // Global Remove Function attached to window
    window.removeFavorite = async function(uid, docId, btn) {
        event.stopPropagation(); // Prevent clicking the card link
        if(!confirm("Remove from favorites?")) return;
        
        try {
            await deleteDoc(doc(db, "users", uid, "favorites", docId));
            const card = btn.closest('.college-card');
            card.style.transform = "scale(0)";
            setTimeout(() => {
                card.remove();
                if(favGrid.children.length === 0) location.reload();
            }, 300);
        } catch(e) {
            alert("Error removing: " + e.message);
        }
    };
</script>
<footer style="padding:28px;text-align:center;color:#666">2026 VIDYA Project | Developed by Samson Varghese, Ewin Job, Jeremiah AR</footer>
</body>
</html>