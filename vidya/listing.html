<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Colleges - VIDYA</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --accent: #ec4899;
            --gradient: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            --bg-light: #f9f9fb;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
        }

        body {
            background-color: var(--bg-light);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-dark);
        }

        /* --- NAVBAR --- */
        .navbar {
            background: var(--gradient) !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: sticky; top: 0; z-index: 1000;
        }
        .navbar-brand { font-weight: 800; font-size: 1.5rem; color: white !important; letter-spacing: 1px; }
        .nav-link { color: rgba(255, 255, 255, 0.9) !important; font-weight: 600; transition: 0.3s; }
        .nav-link:hover { color: white !important; transform: translateY(-1px); }

        /* --- MAIN LAYOUT (2 Columns) --- */
        .listing-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
            display: flex;
            gap: 30px;
            align-items: flex-start; /* Keeps sidebar sticky */
        }

        /* --- NEW FLOATING FILTER SIDEBAR --- */
        .filter-sidebar {
            width: 300px;
            flex-shrink: 0;
            background: white;
            border-radius: 16px;
            position: sticky; 
            top: 90px; /* Offset for navbar */
            height: calc(100vh - 110px); 
            overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.1); 
            border: 1px solid rgba(255,255,255,0.8);
            display: flex; flex-direction: column;
            z-index: 900;
        }

        /* Filter Header */
        .filter-header {
            background: var(--gradient);
            color: white;
            padding: 18px 20px;
            border-radius: 16px 16px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .filter-body { padding: 20px; flex-grow: 1; }
        
        /* Filter Inputs */
        .filter-label { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; margin-top: 15px; }
        .filter-label:first-child { margin-top: 0; }
        
        .form-select {
            border-radius: 10px; border: 1px solid #e5e7eb; padding: 10px;
            font-size: 0.9rem; background-color: #f8fafc; color: #374151; transition: all 0.2s;
        }
        .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); background-color: white; }

        /* Results Area */
        .results-area { flex-grow: 1; min-width: 0; }

        /* --- COLLEGE CARD --- */
        .college-card {
            background: white; border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(0,0,0,0.04); transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative; height: 100%; display: flex; flex-direction: column;
        }
        .college-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }

        .card-cover { height: 80px; background: var(--gradient); position: relative; }
        .card-logo-wrapper {
            width: 70px; height: 70px; background: white; border-radius: 12px;
            padding: 5px; position: absolute; top: 45px; left: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex;
            align-items: center; justify-content: center;
        }
        .card-logo { max-width: 100%; max-height: 100%; object-fit: contain; }

        .card-body { padding: 20px; padding-top: 45px; flex: 1; display: flex; flex-direction: column; }
        .card-badges { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .badge-item { font-size: 0.7rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: #f3f4f6; color: var(--text-muted); }
        .badge-highlight { background: #fdf2f8; color: var(--accent); }

        .college-name {
            font-size: 1.1rem; font-weight: 700; line-height: 1.4; color: var(--text-dark);
            margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .college-meta { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; display: flex; align-items: center; gap: 5px; }

        .card-footer-custom {
            margin-top: auto; border-top: 1px solid #f3f4f6; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center; background: #fafafa;
        }
        .rating-badge { display: flex; align-items: center; gap: 4px; font-weight: 700; font-size: 0.9rem; color: var(--text-dark); }
        .star-icon { color: #fbbf24; }
        .btn-view { color: var(--primary); font-weight: 600; font-size: 0.9rem; text-decoration: none; transition: 0.2s; }
        .btn-view:hover { color: var(--primary-dark); transform: translateX(3px); }

        /* Compare Button */
        .btn-compare-card {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            background: rgba(255, 255, 255, 0.95); 
            border: 1px solid #e2e8f0; color: #64748b; 
            padding: 6px 14px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 700; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn-compare-card:hover { background: white; color: var(--primary); border-color: var(--primary); transform: translateY(-2px); }
        .btn-compare-card.active { background: #dcfce7; color: #166534; border-color: #86efac; }
        .best-value { background-color: #dcfce7 !important; color: #14532d; font-weight: 700; }

        /* Mobile Filter Styles */
        .mobile-filter-btn { display: none; width: 100%; padding: 12px; background: white; border: 1px solid #eee; border-radius: 12px; font-weight: 600; color: var(--primary); margin-bottom: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .filter-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; backdrop-filter: blur(3px); }
        .btn-close-filter { display: none; background: none; border: none; color: white; font-size: 1.2rem; }

        @media (max-width: 991px) {
            .listing-container { flex-direction: column; padding: 20px; }
            .filter-sidebar {
                position: fixed; top: 0; left: -100%; width: 85%; max-width: 320px;
                height: 100vh; border-radius: 0; z-index: 2000;
                transition: left 0.3s ease;
            }
            .filter-sidebar.active { left: 0; }
            .filter-overlay.active { display: block; }
            .filter-header { border-radius: 0; }
            .btn-close-filter { display: block; }
            .mobile-filter-btn { display: block; }
        }

        /* Floating Compare Bar */
        .compare-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 30px;
            border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: none; align-items: center; gap: 20px; z-index: 2000;
            width: 90%; max-width: 500px; justify-content: space-between;
        }
        .compare-bar.active { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { bottom: -100px; } to { bottom: 20px; } }
        
        .compare-btn { background: var(--accent); border: none; padding: 8px 20px; border-radius: 30px; color: white; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .compare-btn:hover { background: #db2777; transform: scale(1.05); }
        .clear-btn { color: #cbd5e1; background: none; border: none; font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        .clear-btn:hover { color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">VIDYA</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span> 
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Home</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="filter-overlay" id="filterOverlay" onclick="toggleFilter()"></div>

    <div class="listing-container">
        
        <aside class="filter-sidebar" id="filterSidebar">
            <div class="filter-header">
                <h5 class="m-0 fw-bold"><i class="fas fa-filter me-2"></i>Filters</h5>
                <div class="d-flex align-items-center gap-3">
                    <a href="#" onclick="resetFilters()" class="text-white text-decoration-none small fw-bold" style="opacity:0.9;">Reset</a>
                    <button class="btn-close-filter" onclick="toggleFilter()"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="filter-body">
                <div class="filter-label">Location</div>
                <select class="form-select" id="filterLocation" onchange="applyFilters()">
                    <option value="">All Locations</option>
                    <option value="Alappuzha">Alappuzha</option>
                    <option value="Ernakulam">Ernakulam</option>
                    <option value="Idukki">Idukki</option>
                    <option value="Kannur">Kannur</option>
                    <option value="Kasaragod">Kasaragod</option>
                    <option value="Kollam">Kollam</option>
                    <option value="Kottayam">Kottayam</option>
                    <option value="Kozhikode">Kozhikode</option>
                    <option value="Malappuram">Malappuram</option>
                    <option value="Palakkad">Palakkad</option>
                    <option value="Pathanamthitta">Pathanamthitta</option>
                    <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                    <option value="Thrissur">Thrissur</option>
                    <option value="Wayanad">Wayanad</option>
                </select>

                <div class="filter-label">University</div>
                <select class="form-select" id="filterUniv" onchange="applyFilters()">
                    <option value="">All Universities</option>
                </select>

                <div class="filter-label">Institution Type</div>
                <select class="form-select" id="filterType" onchange="applyFilters()">
                    <option value="">All Types</option>
                    <option value="Government">Government</option>
                    <option value="Private">Private</option>
                    <option value="Aided">Aided</option>
                    <option value="Autonomous">Autonomous</option>
                </select>

                <div class="filter-label">Stream</div>
                <select class="form-select" id="filterStream" onchange="applyFilters()">
                    <option value="">All Streams</option>
                    <option value="Computer Science">Computer Science</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Management">Management</option>
                    <option value="Medical">Medical</option>
                    <option value="Commerce">Commerce</option>
                    <option value="Arts">Arts</option>
                    <option value="Arts & Science">Arts & Science</option>
                </select>

                <div class="filter-label">Course Name</div>
                <select class="form-select" id="filterCourse" onchange="applyFilters()">
                    <option value="">All Courses</option>
                    <option value="B.Tech">B.Tech</option>
                    <option value="BCA">BCA</option>
                    <option value="BBA">BBA</option>
                    <option value="B.Com">B.Com</option>
                    <option value="MBA">MBA</option>
                    <option value="MCA">MCA</option>
                    <option value="MBBS">MBBS</option>
                </select>

                <div class="filter-label">Max Fee (Per Year)</div>
                <select class="form-select" id="filterFees" onchange="applyFilters()">
                    <option value="">Any Budget</option>
                    <option value="20000">Under ₹20,000</option>
                    <option value="50000">Under ₹50,000</option>
                    <option value="100000">Under ₹1 Lakh</option>
                    <option value="200000">Under ₹2 Lakhs</option>
                </select>
                
                <div class="d-grid d-lg-none mt-4">
                    <button class="btn btn-primary" onclick="toggleFilter()">Show Results</button>
                </div>
            </div>
        </aside>

        <main class="results-area">
            <button class="mobile-filter-btn" onclick="toggleFilter()">
                <i class="fas fa-sliders-h me-2"></i> Open Filters
            </button>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold m-0 text-dark">Browse Colleges</h3>
                    <span class="text-muted small" id="resultCount">Loading...</span>
                </div>
            </div>

            <div id="collegesListContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Finding colleges & courses...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="compareBar" class="compare-bar">
        <div>
            <i class="fas fa-check-circle me-2 text-success"></i>
            <span class="fw-bold" id="compareCount">0</span> Colleges Selected
            <button class="clear-btn ms-2" onclick="clearComparison()">Clear</button>
        </div>
        <button class="compare-btn" onclick="openCompareModal()">Compare Now</button>
    </div>

    <div class="modal fade" id="compareModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-balance-scale me-2 text-primary"></i>Compare Colleges</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pb-5"> 
                    <div id="compareContextMsg" class="alert alert-soft-primary d-flex align-items-center small mb-4" style="background:#eff6ff; border:1px solid #dbeafe; color:#1e40af; border-radius:8px;"></div>
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle">
                            <thead class="table-light" style="border-bottom: 2px solid #e2e8f0;">
                                <tr id="compHeaderRow"><th>Feature</th></tr>
                            </thead>
                            <tbody id="compBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBt5DvViwm5ls_B4CWKYIYhMutJJ9opw_Y",
            authDomain: "vidyaproject-c4a1d.firebaseapp.com",
            projectId: "vidyaproject-c4a1d",
            storageBucket: "vidyaproject-c4a1d.firebasestorage.app",
            messagingSenderId: "637214484165",
            appId: "1:637214484165:web:f23e84c08cd6069f6fb2ac",
            measurementId: "G-647MPHBDGW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allColleges = [];
        let allCourses = []; 
        window.compareList = []; 

        onAuthStateChanged(auth, async (user) => {
            await fetchAllData(); 
            if (user) setTimeout(() => autoCheckFilters(user.uid), 500);
            else { checkUrlParams(); applyFilters(); }
        });

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const q = params.get('q');
            if (q) {
                setSmart('filterLocation', q);
                setSmart('filterUniv', q);
                setSmart('filterStream', q);
            }
        }

        async function fetchAllData() {
            try {
                const colSnap = await getDocs(collection(db, "colleges"));
                allColleges = [];
                colSnap.forEach(doc => allColleges.push({ id: doc.id, ...doc.data() }));

                const courseSnap = await getDocs(collection(db, "courses"));
                allCourses = [];
                courseSnap.forEach(doc => allCourses.push({ id: doc.id, ...doc.data() }));

                allColleges.forEach(college => {
                    college.courseList = allCourses.filter(c => c.college_id === college.id);
                });
                populateUniversities();
            } catch (e) { console.error("Fetch error:", e); }
        }

        function populateUniversities() {
            const univSelect = document.getElementById('filterUniv');
            univSelect.innerHTML = '<option value="">All Universities</option>';
            const profileUniversities = [
                "University of Calicut", "APJ Abdul Kalam Technological University", "University of Kerala",
                "Mahatma Gandhi University", "Cochin University of Science & Technology", "Kannur University"
            ];
            profileUniversities.forEach(univ => {
                const opt = document.createElement('option');
                opt.value = univ; opt.innerText = univ; univSelect.appendChild(opt);
            });
        }

        window.applyFilters = function() {
            const loc = getVal('filterLocation');
            const univ = getVal('filterUniv');
            const stream = getVal('filterStream');
            const courseName = getVal('filterCourse');
            const maxFee = getVal('filterFees');
            const type = getVal('filterType');

            const filtered = allColleges.filter(col => {
                if (loc && !flexibleMatch(col.district, loc) && !flexibleMatch(col.location, loc)) return false;
                if (univ && !flexibleMatch(col.university, univ)) return false;
                
                let streamPass = false;
                if (!stream) streamPass = true;
                else {
                    if (flexibleMatch(col.stream, stream)) streamPass = true;
                    else if (stream === "Computer Science" && flexibleMatch(col.stream, "Engineering")) streamPass = true;
                }
                if (!streamPass) return false;

                if (type && !flexibleMatch(col.institution_type, type) && !flexibleMatch(col.institutionType, type)) return false;

                if (courseName || maxFee) {
                    const validCourses = col.courseList.filter(c => {
                        let nameMatch = true;
                        let feeMatch = true;
                        if (courseName && !c.name.toLowerCase().includes(courseName.toLowerCase())) nameMatch = false;
                        if (maxFee) {
                            const fees = parseInt(c.fees || 0);
                            if (fees === 0 || fees > parseInt(maxFee)) feeMatch = false;
                        }
                        return nameMatch && feeMatch;
                    });
                    if (validCourses.length === 0) return false;
                }
                return true;
            });
            renderGroupedColleges(filtered);
        };

        function renderGroupedColleges(colleges) {
            const container = document.getElementById('collegesListContainer');
            const countLabel = document.getElementById('resultCount');
            
            container.innerHTML = "";
            countLabel.innerText = `Showing ${colleges.length} results`;

            if(colleges.length === 0) {
                container.innerHTML = `<div class="text-center py-5"><h5>No colleges found</h5><button class="btn btn-outline-primary mt-2" onclick="resetFilters()">Reset All Filters</button></div>`;
                return;
            }

            colleges.sort((a, b) => (a.district || "z").localeCompare(b.district || "z"));

            let lastDistrict = null;
            let currentGrid = null;

            colleges.forEach(col => {
                const district = col.district || "Other Locations";

                if (district !== lastDistrict) {
                    container.insertAdjacentHTML('beforeend', `<h4 class="location-heading">${district}</h4>`);
                    currentGrid = document.createElement('div');
                    currentGrid.className = "row g-4 mb-4";
                    container.appendChild(currentGrid);
                    lastDistrict = district;
                }

                const logo = col.logo_path || 'assets/default-college.png';
                const typeBadge = col.institution_type ? `<span class="badge-item badge-highlight">${col.institution_type}</span>` : '';
                const streamBadge = col.stream ? `<span class="badge-item">${col.stream}</span>` : '';
                const courseCountBadge = `<span class="badge-item bg-light text-dark">${col.courseList.length} Courses</span>`;
                
                const isSelected = window.compareList.includes(col.id);
                const btnClass = isSelected ? 'btn-compare-card active' : 'btn-compare-card';
                const btnIcon = isSelected ? 'fa-check' : 'fa-plus';
                const btnText = isSelected ? 'Added' : 'Compare';

                const cardHTML = `
                <div class="col-md-6 col-lg-4">
                    <div class="college-card">
                        <button class="${btnClass}" onclick="toggleCompare('${col.id}', this)">
                            <i class="fas ${btnIcon}"></i> ${btnText}
                        </button>
                        <a href="college.html?id=${col.id}" class="text-decoration-none">
                            <div class="card-cover"></div>
                            <div class="card-logo-wrapper"><img src="${logo}" class="card-logo" alt="Logo"></div>
                            <div class="card-body">
                                <div class="card-badges">${streamBadge} ${typeBadge} ${courseCountBadge}</div>
                                <h5 class="college-name">${col.name}</h5>
                                <div class="college-meta"><i class="fas fa-university fa-sm"></i> ${col.university || 'Affiliated'}</div>
                            </div>
                            <div class="card-footer-custom">
                                <div class="rating-badge"><i class="fas fa-star star-icon"></i> ${col.rating || '0.0'}</div>
                                <span class="btn-view">View Details <i class="fas fa-arrow-right ms-1"></i></span>
                            </div>
                        </a>
                    </div>
                </div>`;
                currentGrid.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        window.toggleCompare = function(id, btn) {
            const idx = window.compareList.indexOf(id);
            if(idx > -1) {
                window.compareList.splice(idx, 1);
                btn.classList.remove('active');
                btn.innerHTML = `<i class="fas fa-plus"></i> Compare`;
            } else {
                if(window.compareList.length >= 3) { alert("You can compare maximum 3 colleges."); return; }
                window.compareList.push(id);
                btn.classList.add('active');
                btn.innerHTML = `<i class="fas fa-check"></i> Added`;
            }
            updateCompareBar();
        }

        function updateCompareBar() {
            const bar = document.getElementById('compareBar');
            const count = document.getElementById('compareCount');
            if(window.compareList.length > 0) {
                bar.style.display = 'flex'; // FORCE DISPLAY
                bar.classList.add('active');
                count.innerText = window.compareList.length;
            } else {
                bar.classList.remove('active');
                bar.style.display = 'none'; // FORCE HIDE
            }
        }

        window.clearComparison = function() {
            window.compareList = [];
            
            // 1. Force hide the bar immediately
            const bar = document.getElementById('compareBar');
            bar.classList.remove('active');
            bar.style.display = 'none';

            // 2. Refresh all buttons to "Compare" state
            applyFilters(); 
        }

        // --- HIDE BAR ON MODAL OPEN ---
        const compareBarEl = document.getElementById('compareBar');
        const compareModalEl = document.getElementById('compareModal');

        compareModalEl.addEventListener('show.bs.modal', () => { compareBarEl.style.display = 'none'; });
        compareModalEl.addEventListener('hidden.bs.modal', () => { 
            if(window.compareList.length > 0) compareBarEl.style.display = 'flex'; 
        });

        window.openCompareModal = function() {
            const modal = new bootstrap.Modal(compareModalEl);
            const tbody = document.getElementById('compBody');
            const headerRow = document.getElementById('compHeaderRow');
            const ctxMsg = document.getElementById('compareContextMsg');
            
            const selectedCols = allColleges.filter(c => window.compareList.includes(c.id));
            if(selectedCols.length < 2) { alert("Select at least 2 colleges."); return; }

            const activeCourse = getVal('filterCourse');
            
            if(activeCourse) {
                ctxMsg.style.display = 'block';
                ctxMsg.innerHTML = `<i class="fas fa-info-circle me-2"></i>Comparison optimized for <strong>${activeCourse}</strong> course. Highlights indicate best value.`;
            } else {
                ctxMsg.style.display = 'block';
                ctxMsg.innerHTML = `<i class="fas fa-lightbulb me-2"></i>Tip: Select a <strong>Course Name</strong> in the filter to compare exact Fees & Duration.`;
            }

            headerRow.innerHTML = `<th>Feature</th>` + selectedCols.map(c => 
                `<th><img src="${c.logo_path || 'assets/default-college.png'}" style="width:40px; height:40px; object-fit:contain; margin-bottom:5px;"><br>${c.name}</th>`
            ).join('');

            let rows = [
                { label: "Rating", key: "rating", highlightMax: true },
                { label: "University", key: "university" },
                { label: "Type", key: "institution_type" },
                { label: "Location", key: "district" },
            ];

            if(activeCourse) {
                rows.push({ label: "Course", val: () => activeCourse });
                rows.push({ 
                    label: "Tuition Fee (Approx)", 
                    highlightMin: true, 
                    val: (c) => {
                        const course = c.courseList.find(x => x.name.toLowerCase().includes(activeCourse.toLowerCase()));
                        return course ? `₹${course.fees}` : 'N/A';
                    },
                    rawVal: (c) => { 
                        const course = c.courseList.find(x => x.name.toLowerCase().includes(activeCourse.toLowerCase()));
                        return course ? parseInt(course.fees) : 9999999;
                    }
                });
                rows.push({ 
                    label: "Seats",
                    highlightMax: true,
                    val: (c) => {
                        const course = c.courseList.find(x => x.name.toLowerCase().includes(activeCourse.toLowerCase()));
                        return course ? course.seats : '-';
                    },
                    rawVal: (c) => { 
                        const course = c.courseList.find(x => x.name.toLowerCase().includes(activeCourse.toLowerCase()));
                        return course ? parseInt(course.seats) : 0;
                    }
                });
                rows.push({ 
                    label: "Duration", 
                    val: (c) => {
                        const course = c.courseList.find(x => x.name.toLowerCase().includes(activeCourse.toLowerCase()));
                        return course ? course.duration : '-';
                    }
                });
            } else {
                rows.push({ label: "Total Courses", val: (c) => c.courseList.length });
            }

            tbody.innerHTML = rows.map(r => {
                let bestIdx = -1;
                if(r.highlightMax || r.highlightMin) {
                    const values = selectedCols.map(c => r.rawVal ? r.rawVal(c) : parseFloat(c[r.key] || 0));
                    if(r.highlightMax) {
                        const max = Math.max(...values);
                        if(max > 0) bestIdx = values.indexOf(max);
                    } else {
                        const validValues = values.filter(v => v > 0 && v < 999999);
                        const min = Math.min(...validValues);
                        if(validValues.length > 0) bestIdx = values.indexOf(min);
                    }
                }

                return `<tr>
                    <td class="fw-bold bg-light">${r.label}</td>
                    ${selectedCols.map((c, i) => `
                        <td class="${i === bestIdx ? 'best-value' : ''}">
                            ${r.val ? r.val(c) : (c[r.key] || '-')}
                        </td>
                    `).join('')}
                </tr>`;
            }).join('');

            modal.show();
        }

        const getVal = (id) => document.getElementById(id).value;
        const flexibleMatch = (dataVal, filterVal) => {
            if (!filterVal) return true; 
            if (!dataVal) return false;
            const cleanData = dataVal.toLowerCase().replace(/[^a-z0-9]/g, '');
            const cleanFilter = filterVal.toLowerCase().replace(/[^a-z0-9]/g, '');
            return cleanData.includes(cleanFilter) || cleanFilter.includes(cleanData);
        };

        async function autoCheckFilters(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists()) {
                    const u = docSnap.data();
                    if(u.location) setSmart('filterLocation', u.location);
                    else if(u.district) setSmart('filterLocation', u.district);
                    if(u.stream) setSmart('filterStream', u.stream);
                    if(u.university) setSmart('filterUniv', u.university);
                    if(u.institutionType) setSmart('filterType', u.institutionType);
                    if(u.degree) setSmart('filterCourse', u.degree);
                    applyFilters();
                }
            } catch (e) { console.error("Error loading user profile:", e); }
        }

        function setSmart(id, val) {
            const el = document.getElementById(id);
            if(!el || !val) return;
            const cleanVal = val.toLowerCase().replace(/[^a-z0-9]/g, '');
            for(let opt of el.options) {
                const cleanOpt = opt.value.toLowerCase().replace(/[^a-z0-9]/g, '');
                if(cleanOpt && (cleanOpt.includes(cleanVal) || cleanVal.includes(cleanOpt))) { 
                    el.value = opt.value; 
                    return; 
                }
            }
        }

        window.resetFilters = function() {
            document.querySelectorAll('select').forEach(s => s.value = "");
            applyFilters();
        }

        // Mobile Filter Toggle (Custom, no bootstrap offcanvas JS needed for sidebar mode)
        window.toggleFilter = function() {
            const sidebar = document.getElementById('filterSidebar');
            const overlay = document.getElementById('filterOverlay');
            if(sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        }
    </script>
</body>
</html>