<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Content Hub Manager - VIDYA Admin</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f4f6f9; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .admin-wrapper { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .admin-header { background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%); color: white; padding: 20px 30px; }
        .form-section { padding: 40px; }
        .btn-submit { background-color: #4338ca; color: white; width: 100%; padding: 12px; font-weight: bold; border-radius: 8px; border: none; margin-top: 20px; transition: 0.3s; }
        .btn-submit:hover { background-color: #3730a3; }
        .btn-success { width: 100%; padding: 12px; font-weight: bold; border-radius: 8px; border: none; margin-top: 20px; transition: 0.3s; }
        #statusMsg { position: fixed; bottom: 30px; right: 30px; background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); font-weight: bold; display: none; z-index: 9999; }
    </style>
</head>
<body>

<div class="admin-wrapper">
    <div class="admin-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;" id="pageTitle"><i class="fas fa-book-open me-2"></i>Content Hub Manager</h2>
            <a href="admin-dashboard.html" class="btn btn-light btn-sm fw-bold"><i class="fas fa-arrow-left me-1"></i> Dashboard</a>
        </div>
    </div>

    <div class="form-section">
        <h5 class="text-primary mb-4" id="formHeader"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Study Material</h5>
        
        <div class="mb-3">
            <label class="fw-bold">1. Select Course Stream</label>
            <select id="hubStream" class="form-select form-select-lg">
                <option value="bca">BCA</option><option value="bba">BBA</option>
                <option value="bcom">B.Com</option><option value="mba">MBA</option>
                <option value="mcom">M.Com</option><option value="mca">MCA</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="fw-bold">2. Select Semester</label>
            <select id="hubSem" class="form-select">
                <option value="1">Semester 1</option><option value="2">Semester 2</option>
                <option value="3">Semester 3</option><option value="4">Semester 4</option>
                <option value="5">Semester 5</option><option value="6">Semester 6</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="fw-bold">3. Subject Name</label>
            <input type="text" id="hubSubject" class="form-control" placeholder="e.g. Data Structures, Financial Accounting">
        </div>

        <div class="mb-3">
            <label class="fw-bold">4. Material Details</label>
            <input type="text" id="hubTitle" class="form-control mb-2" placeholder="Material Title (e.g. Unit 1 Notes)">
            <input type="text" id="hubLink" class="form-control" placeholder="PDF / Google Drive Link">
        </div>

        <button class="btn-submit" id="saveBtn" onclick="saveContent()">UPLOAD MATERIAL</button>
    </div>
</div>

<div id="statusMsg"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBt5DvViwm5ls_B4CWKYIYhMutJJ9opw_Y",
        authDomain: "vidyaproject-c4a1d.firebaseapp.com",
        projectId: "vidyaproject-c4a1d",
        storageBucket: "vidyaproject-c4a1d.firebasestorage.app",
        messagingSenderId: "637214484165",
        appId: "1:637214484165:web:f23e84c08cd6069f6fb2ac",
        measurementId: "G-647MPHBDGW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');

    // --- SECURITY CHECK (UPDATED) ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "admin_login.html";
            return;
        }
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().role !== "admin") {
                alert("Access Denied: Admins Only.");
                window.location.href = "index.html";
            } else if (editId) {
                await loadEditData(editId);
            }
        } catch (error) {
            window.location.href = "index.html";
        }
    });

    const get = (id) => document.getElementById(id).value.trim();
    const set = (id, val) => document.getElementById(id).value = val;
    
    const showMsg = (msg, success=true) => {
        const el = document.getElementById('statusMsg');
        el.innerText = msg;
        el.style.display = 'block';
        el.style.borderLeft = success ? "5px solid green" : "5px solid red";
        setTimeout(() => el.style.display = 'none', 3000);
    };

    async function loadEditData(id) {
        document.getElementById('pageTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Material';
        document.getElementById('formHeader').innerHTML = '<i class="fas fa-edit me-2"></i>Update Details';
        document.getElementById('saveBtn').innerText = "UPDATE MATERIAL";
        document.getElementById('saveBtn').className = "btn-success"; 

        try {
            const docSnap = await getDoc(doc(db, "content_hub_materials", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                set('hubStream', d.course_code);
                set('hubSem', d.semester);
                set('hubSubject', d.subject_name);
                set('hubTitle', d.title);
                set('hubLink', d.file_path);
            } else {
                showMsg("Material not found!", false);
            }
        } catch(e) { console.error(e); }
    }

    window.saveContent = async function() {
        if(!get('hubSubject') || !get('hubTitle') || !get('hubLink')) {
            showMsg("Please fill all fields!", false); return;
        }

        const data = {
            course_code: get('hubStream'), 
            semester: parseInt(get('hubSem')), 
            subject_name: get('hubSubject'),
            title: get('hubTitle'),
            file_path: get('hubLink'),
            material_type: 'notes',
            updatedAt: new Date()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, "content_hub_materials", editId), data);
                showMsg("Material Updated Successfully!");
            } else {
                data.createdAt = new Date();
                await addDoc(collection(db, "content_hub_materials"), data);
                showMsg("Material Uploaded Successfully!");
                document.getElementById('hubTitle').value = '';
                document.getElementById('hubLink').value = '';
            }
        } catch(e) {
            console.error(e);
            showMsg("Error: " + e.message, false);
        }
    };
</script>
</body>
</html>