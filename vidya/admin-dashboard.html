<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - VIDYA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%); padding: 15px; }
        .navbar-brand { font-weight: bold; color: white !important; font-size: 1.5rem; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; }
        
        .dashboard-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        
        /* Action Cards */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        .action-card {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center;
            transition: transform 0.2s; text-decoration: none; color: inherit; border: 1px solid #eee;
        }
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(110, 27, 214, 0.15); border-color: #6e1bd6; }
        
        .icon-box { width: 70px; height: 70px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        
        .ac-college .icon-box { background: #e0e7ff; color: #4338ca; }
        .ac-content .icon-box { background: #e0e7ff; color: #4338ca; }
        
        /* Table */
        .card { border: none; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .table thead { background-color: #f8f9fa; }
        .table th { padding: 15px; font-weight: 600; color: #555; }
        .table td { padding: 15px; vertical-align: middle; }
        
        /* Badges */
        .badge-soft { padding: 5px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; }
        .bg-soft-blue { background: #e0e7ff; color: #4338ca; }

        /* Search Bar */
        .search-wrapper { position: relative; margin-bottom: 20px; }
        .search-wrapper input { padding-left: 40px; border-radius: 30px; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt me-2"></i>VIDYA Admin</a>
            <button id="logoutBtn" class="btn btn-logout btn-sm">Logout</button>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <div class="action-grid">
            <a href="admin-college-forms.html" class="action-card ac-college">
                <div class="icon-box"><i class="fas fa-university"></i></div>
                <h3>Manage Colleges</h3>
                <p>Add or Edit colleges, courses, and details.</p>
                <span class="btn btn-sm btn-outline-primary mt-2">Go to Form &rarr;</span>
            </a>

            <a href="admin-content-hub.html" class="action-card ac-content">
                <div class="icon-box"><i class="fas fa-book-open"></i></div>
                <h3>Manage Content Hub</h3>
                <p>Upload syllabus, notes, and previous questions.</p>
                <span class="btn btn-sm btn-outline-primary mt-2">Go to Content Form &rarr;</span>
            </a>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-secondary m-0">Full Overview</h4>
            <div class="search-wrapper" style="width: 300px;">
                <i class="fas fa-search"></i>
                <input type="text" id="adminSearch" class="form-control" placeholder="Search data...">
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white border-bottom-0">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                   <li class="nav-item"><button class="nav-link active" id="tab-colleges" data-bs-toggle="tab" data-bs-target="#view-colleges" type="button">Colleges</button></li>
                   <li class="nav-item"><button class="nav-link" id="tab-content" data-bs-toggle="tab" data-bs-target="#view-content" type="button">Content Hub</button></li>
                   <li class="nav-item"><button class="nav-link" id="tab-users" data-bs-toggle="tab" data-bs-target="#view-users" type="button">Manage Users</button></li>
                </ul>
            </div>
            
            <div class="card-body p-0">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="view-colleges">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4" style="width: 50px;">#</th>
                                        <th>College Name</th>
                                        <th>Location</th>
                                        <th>Stream</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="collegeTableBody">
                                    <tr><td colspan="5" class="text-center py-5">Loading Colleges...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="view-content">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4" style="width: 50px;">#</th>
                                        <th>Title</th>
                                        <th>Stream/Sem</th>
                                        <th>Subject</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="contentTableBody">
                                    <tr><td colspan="5" class="text-center py-5">Loading Content...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="view-users">
                      <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                   <th class="ps-4" style="width: 50px;">#</th>
                                   <th>Name</th>
                                   <th>Email / Contact</th> <th>Current Role</th>
                                   <th class="text-end pe-4">Action</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="5" class="text-center py-5">Loading Users...</td></tr>
                            </tbody>
                        </table>
                      </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, deleteDoc, getDoc, doc, orderBy, query, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBt5DvViwm5ls_B4CWKYIYhMutJJ9opw_Y",
            authDomain: "vidyaproject-c4a1d.firebaseapp.com",
            projectId: "vidyaproject-c4a1d",
            storageBucket: "vidyaproject-c4a1d.firebasestorage.app",
            messagingSenderId: "637214484165",
            appId: "1:637214484165:web:f23e84c08cd6069f6fb2ac",
            measurementId: "G-647MPHBDGW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- SECURITY CHECK (UPDATED) ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "admin_login.html";
                return;
            }

            try {
                // Check if user is actually an admin
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists() || userDoc.data().role !== "admin") {
                    alert("Access Denied: Admins Only.");
                    window.location.href = "index.html";
                } else {
                    // Safe to load dashboard
                    currentUser = user;
                    loadColleges();
                    loadContentHub();
                    loadUsers();
                }
            } catch (error) {
                console.error("Auth Error:", error);
                window.location.href = "index.html";
            }
        });

        // --- SEARCH FUNCTIONALITY ---
        document.getElementById('adminSearch').addEventListener('keyup', function() {
            const val = this.value.toLowerCase();
            let activeTableId = "";
            if (document.getElementById('view-colleges').classList.contains('active')) activeTableId = "collegeTableBody";
            else if (document.getElementById('view-content').classList.contains('active')) activeTableId = "contentTableBody";
            else if (document.getElementById('view-users').classList.contains('active')) activeTableId = "usersTableBody";

            const rows = document.getElementById(activeTableId).getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const text = rows[i].textContent || rows[i].innerText;
                rows[i].style.display = text.toLowerCase().indexOf(val) > -1 ? "" : "none";
            }
        });

        // 1. LOAD ALL COLLEGES
        async function loadColleges() {
            const tbody = document.getElementById('collegeTableBody');
            try {
                const q = query(collection(db, "colleges"), orderBy("name", "asc"));
                const snap = await getDocs(q);
                
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No colleges found.</td></tr>'; return; }

                tbody.innerHTML = ''; 
                snap.docs.forEach((doc, index) => {
                    const d = doc.data();
                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4 text-secondary">${index + 1}</td>
                            <td class="fw-bold text-primary">${d.name}</td>
                            <td>${d.location}</td>
                            <td><span class="badge badge-soft bg-soft-blue">${d.stream}</span></td>
                            <td class="text-end pe-4">
                                <a href="admin-college-forms.html?id=${doc.id}" class="btn btn-sm btn-outline-secondary me-1" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="delCollege('${doc.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        // 2. LOAD CONTENT HUB
        async function loadContentHub() {
            const tbody = document.getElementById('contentTableBody');
            try {
                const q = query(collection(db, "content_hub_materials"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No materials uploaded.</td></tr>'; return; }

                tbody.innerHTML = ''; 
                snap.docs.forEach((doc, index) => {
                    const d = doc.data();
                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4 text-secondary">${index + 1}</td>
                            <td class="fw-bold">${d.title}</td>
                            <td><span class="badge badge-soft bg-soft-blue">${d.course_code.toUpperCase()} - S${d.semester}</span></td>
                            <td>${d.subject_name}</td>
                            <td class="text-end pe-4">
                                <a href="admin-content-hub.html?id=${doc.id}" class="btn btn-sm btn-outline-secondary me-1" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="delContent('${doc.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        // 3. LOAD ALL USERS
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            try {
                const snap = await getDocs(collection(db, "users"));
                tbody.innerHTML = ''; 
                snap.docs.forEach((docSnap, index) => {
                    const user = docSnap.data();
                    const isMe = docSnap.id === currentUser.uid; 
                    const isAdmin = user.role === 'admin';
                    const displayEmail = user.email || user.contact || "No Email";

                    let actionBtn = '';
                    if(isMe) {
                        actionBtn = `<span class="badge bg-secondary">Current User</span>`;
                    } else if(isAdmin) {
                        actionBtn = `<button class="btn btn-sm btn-outline-warning" onclick="toggleRole('${docSnap.id}', 'student')">Demote</button>`;
                    } else {
                        actionBtn = `<button class="btn btn-sm btn-success" onclick="toggleRole('${docSnap.id}', 'admin')">Promote</button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4 text-secondary">${index + 1}</td>
                            <td class="fw-bold">${user.name || 'No Name'}</td>
                            <td>${displayEmail}</td>
                            <td><span class="badge ${isAdmin ? 'bg-success' : 'bg-secondary'}">${user.role || 'student'}</span></td>
                            <td class="text-end pe-4">${actionBtn}</td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        // ACTIONS
        window.toggleRole = async function(uid, newRole) {
            if(!confirm(`⚠️ CONFIRM ACTION\n\nAre you sure you want to change this user's role to ${newRole.toUpperCase()}?`)) return;
            try {
                await updateDoc(doc(db, "users", uid), { role: newRole });
                alert("Role Updated Successfully!");
                loadUsers(); 
            } catch(e) { alert("Error: " + e.message); }
        }

        window.delCollege = async function(id) {
            if(confirm("⚠ Permanently delete this college?")) {
                try {
                    await deleteDoc(doc(db, "colleges", id));
                    loadColleges();
                } catch(e) { alert("Error: " + e.message); }
            }
        }

        window.delContent = async function(id) {
            if(confirm("⚠ Delete this material?")) {
                try {
                    await deleteDoc(doc(db, "content_hub_materials", id));
                    loadContentHub();
                } catch(e) { alert("Error: " + e.message); }
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>